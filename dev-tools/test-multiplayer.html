<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Arcade - Multiplayer Test Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-indigo-900 p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-4">ðŸ§ª Multiplayer Test Tool</h1>
            <p class="text-gray-300">Simulate multiple players for testing Mini Arcade multiplayer functionality</p>
        </div>

        <!-- Configuration Panel -->
        <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">Configuration</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Environment Settings -->
                <div>
                    <label class="block text-white font-semibold mb-2">Supabase URL</label>
                    <input type="url" id="supabaseUrl" 
                           class="w-full px-4 py-2 bg-black/20 border border-white/20 rounded-lg text-white placeholder-gray-400"
                           placeholder="https://your-project.supabase.co">
                </div>
                
                <div>
                    <label class="block text-white font-semibold mb-2">Supabase Key</label>
                    <input type="password" id="supabaseKey" 
                           class="w-full px-4 py-2 bg-black/20 border border-white/20 rounded-lg text-white placeholder-gray-400"
                           placeholder="Your anon key">
                </div>
                
                <div>
                    <label class="block text-white font-semibold mb-2">Demo Mode</label>
                    <select id="demoMode" 
                            class="w-full px-4 py-2 bg-black/20 border border-white/20 rounded-lg text-white">
                        <option value="true">True (Demo)</option>
                        <option value="false">False (Production)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-white font-semibold mb-2">Number of Test Players</label>
                    <input type="number" id="playerCount" value="3" min="1" max="10"
                           class="w-full px-4 py-2 bg-black/20 border border-white/20 rounded-lg text-white">
                </div>
            </div>
            
            <div class="mt-6 flex gap-4">
                <button id="connectBtn" 
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    Connect
                </button>
                <button id="disconnectBtn" 
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    Disconnect
                </button>
                <button id="clearLogsBtn" 
                        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    Clear Logs
                </button>
            </div>
        </div>

        <!-- Test Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- Player Actions -->
            <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-6">
                <h2 class="text-2xl font-bold text-white mb-4">Player Actions</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-white font-semibold mb-2">Player Name</label>
                        <input type="text" id="testPlayerName" value="TestPlayer" 
                               class="w-full px-4 py-2 bg-black/20 border border-white/20 rounded-lg text-white">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button id="joinBtn" 
                                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Join Game
                        </button>
                        <button id="leaveBtn" 
                                class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Leave Game
                        </button>
                    </div>
                </div>
            </div>

            <!-- Score Testing -->
            <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-6">
                <h2 class="text-2xl font-bold text-white mb-4">Score Testing</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-white font-semibold mb-2">Game</label>
                        <select id="testGame" 
                                class="w-full px-4 py-2 bg-black/20 border border-white/20 rounded-lg text-white">
                            <option value="reaction">Reaction Test</option>
                            <option value="clickspeed">Click Speed</option>
                            <option value="aimtrainer">Aim Trainer</option>
                            <option value="memory">Memory Flip</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-white font-semibold mb-2">Score</label>
                        <input type="number" id="testScore" value="250" 
                               class="w-full px-4 py-2 bg-black/20 border border-white/20 rounded-lg text-white">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button id="sendScoreBtn" 
                                class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Send Score
                        </button>
                        <button id="randomScoreBtn" 
                                class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                            Random Score
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status and Logs -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Connection Status -->
            <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-6">
                <h2 class="text-2xl font-bold text-white mb-4">Connection Status</h2>
                
                <div id="connectionStatus" class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-300">Status:</span>
                        <span id="statusText" class="text-red-400">Disconnected</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Mode:</span>
                        <span id="modeText" class="text-gray-400">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Players:</span>
                        <span id="playersText" class="text-gray-400">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-300">Client ID:</span>
                        <span id="clientIdText" class="text-gray-400 text-xs">-</span>
                    </div>
                </div>
            </div>

            <!-- Active Players -->
            <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-6">
                <h2 class="text-2xl font-bold text-white mb-4">Active Players</h2>
                
                <div id="playersListContainer" class="space-y-2 max-h-48 overflow-y-auto">
                    <div class="text-gray-400 text-sm">No players connected</div>
                </div>
            </div>
        </div>

        <!-- Event Logs -->
        <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-6 mt-8">
            <h2 class="text-2xl font-bold text-white mb-4">Event Logs</h2>
            
            <div id="eventLogs" class="bg-black/30 rounded-lg p-4 max-h-96 overflow-y-auto font-mono text-sm">
                <div class="text-green-400">[INFO] Multiplayer test tool loaded</div>
            </div>
        </div>
    </div>

    <!-- Include the necessary scripts -->
    <script src="../auth.js"></script>
    <script src="../supabase.js"></script>
    <script src="../scores.js"></script>

    <script>
        class MultiplayerTestTool {
            constructor() {
                this.multiplayer = null;
                this.testPlayers = [];
                this.isConnected = false;
                
                this.initializeUI();
                this.loadSavedConfig();
                this.log('Test tool initialized', 'info');
            }

            initializeUI() {
                // Configuration buttons
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());
                document.getElementById('clearLogsBtn').addEventListener('click', () => this.clearLogs());

                // Player action buttons
                document.getElementById('joinBtn').addEventListener('click', () => this.simulatePlayerJoin());
                document.getElementById('leaveBtn').addEventListener('click', () => this.simulatePlayerLeave());

                // Score testing buttons
                document.getElementById('sendScoreBtn').addEventListener('click', () => this.sendTestScore());
                document.getElementById('randomScoreBtn').addEventListener('click', () => this.sendRandomScore());

                // Auto-generate random scores for the selected game
                document.getElementById('testGame').addEventListener('change', () => this.generateRandomScore());
            }

            loadSavedConfig() {
                // Load saved configuration from localStorage
                const config = localStorage.getItem('miniArcadeTestConfig');
                if (config) {
                    const parsed = JSON.parse(config);
                    document.getElementById('supabaseUrl').value = parsed.url || '';
                    document.getElementById('supabaseKey').value = parsed.key || '';
                    document.getElementById('demoMode').value = parsed.demo || 'true';
                    document.getElementById('playerCount').value = parsed.players || '3';
                }
            }

            saveConfig() {
                const config = {
                    url: document.getElementById('supabaseUrl').value,
                    key: document.getElementById('supabaseKey').value,
                    demo: document.getElementById('demoMode').value,
                    players: document.getElementById('playerCount').value
                };
                localStorage.setItem('miniArcadeTestConfig', JSON.stringify(config));
            }

            async connect() {
                try {
                    this.log('Attempting to connect...', 'info');
                    this.saveConfig();

                    // Set environment variables for testing
                    const url = document.getElementById('supabaseUrl').value;
                    const key = document.getElementById('supabaseKey').value;
                    const demo = document.getElementById('demoMode').value;

                    if (!demo || demo === 'true') {
                        window.IS_DEMO = 'true';
                        this.log('Running in demo mode', 'warn');
                    } else {
                        window.IS_DEMO = 'false';
                        window.SUPABASE_URL = url;
                        window.SUPABASE_KEY = key;
                        this.log(`Connecting to production: ${url}`, 'info');
                    }

                    // Initialize multiplayer
                    this.multiplayer = window.initMultiplayer();
                    
                    // Set up event listeners
                    this.multiplayer.onMessage('player_join', (data) => {
                        this.log(`Player joined: ${data.user}`, 'player');
                        this.updatePlayersDisplay();
                    });

                    this.multiplayer.onMessage('player_leave', (data) => {
                        this.log(`Player left: ${data.user}`, 'player');
                        this.updatePlayersDisplay();
                    });

                    this.multiplayer.onMessage('score_update', (data) => {
                        this.log(`Score received: ${data.user} - ${data.score} in ${data.game}`, 'score');
                    });

                    this.isConnected = true;
                    this.updateConnectionStatus();
                    this.log('Connected successfully!', 'success');

                    // Generate test players
                    this.generateTestPlayers();

                } catch (error) {
                    this.log(`Connection failed: ${error.message}`, 'error');
                }
            }

            disconnect() {
                if (this.multiplayer) {
                    window.disconnectMultiplayer();
                    this.multiplayer = null;
                }
                
                this.isConnected = false;
                this.testPlayers = [];
                this.updateConnectionStatus();
                this.updatePlayersDisplay();
                this.log('Disconnected', 'warn');
            }

            generateTestPlayers() {
                const count = parseInt(document.getElementById('playerCount').value);
                const names = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry', 'Ivy', 'Jack'];
                
                for (let i = 0; i < Math.min(count, names.length); i++) {
                    setTimeout(() => {
                        this.simulatePlayerJoin(names[i]);
                    }, i * 1000);
                }
            }

            simulatePlayerJoin(playerName = null) {
                if (!this.isConnected) {
                    this.log('Not connected - cannot simulate player join', 'error');
                    return;
                }

                const name = playerName || document.getElementById('testPlayerName').value || 'TestPlayer';
                const playerId = `test_${name.toLowerCase()}_${Date.now()}`;
                
                const playerData = {
                    user: name,
                    id: playerId,
                    joinTime: new Date().toISOString()
                };

                this.testPlayers.push(playerData);
                
                if (this.multiplayer) {
                    this.multiplayer.handlePlayerJoin(playerData);
                }
                
                this.log(`Simulated player join: ${name}`, 'player');
            }

            simulatePlayerLeave() {
                if (this.testPlayers.length === 0) {
                    this.log('No test players to remove', 'warn');
                    return;
                }

                const player = this.testPlayers.pop();
                
                if (this.multiplayer) {
                    this.multiplayer.handlePlayerLeave(player);
                }
                
                this.log(`Simulated player leave: ${player.user}`, 'player');
            }

            sendTestScore() {
                if (!this.isConnected) {
                    this.log('Not connected - cannot send score', 'error');
                    return;
                }

                const game = document.getElementById('testGame').value;
                const score = parseFloat(document.getElementById('testScore').value);
                const playerName = document.getElementById('testPlayerName').value || 'TestPlayer';

                if (this.multiplayer) {
                    this.multiplayer.handleScoreUpdate({
                        user: playerName,
                        id: `test_${playerName.toLowerCase()}`,
                        game: game,
                        score: score,
                        timestamp: Date.now()
                    });
                }

                this.log(`Sent test score: ${playerName} - ${score} in ${game}`, 'score');
            }

            sendRandomScore() {
                this.generateRandomScore();
                setTimeout(() => this.sendTestScore(), 100);
            }

            generateRandomScore() {
                const game = document.getElementById('testGame').value;
                let randomScore;

                switch (game) {
                    case 'reaction':
                        randomScore = Math.floor(Math.random() * 300) + 150; // 150-450ms
                        break;
                    case 'clickspeed':
                        randomScore = (Math.random() * 12 + 3).toFixed(1); // 3-15 CPS
                        break;
                    case 'aimtrainer':
                        randomScore = Math.floor(Math.random() * 80) + 20; // 20-100 points
                        break;
                    case 'memory':
                        randomScore = Math.floor(Math.random() * 60) + 20; // 20-80 seconds
                        break;
                    default:
                        randomScore = Math.floor(Math.random() * 1000);
                }

                document.getElementById('testScore').value = randomScore;
            }

            updateConnectionStatus() {
                const statusText = document.getElementById('statusText');
                const modeText = document.getElementById('modeText');
                const playersText = document.getElementById('playersText');
                const clientIdText = document.getElementById('clientIdText');

                if (this.isConnected && this.multiplayer) {
                    const status = this.multiplayer.getStatus();
                    
                    statusText.textContent = 'Connected';
                    statusText.className = 'text-green-400';
                    
                    modeText.textContent = status.mode || 'Unknown';
                    playersText.textContent = status.playerCount || '0';
                    clientIdText.textContent = status.clientId || '-';
                } else {
                    statusText.textContent = 'Disconnected';
                    statusText.className = 'text-red-400';
                    
                    modeText.textContent = '-';
                    playersText.textContent = '0';
                    clientIdText.textContent = '-';
                }
            }

            updatePlayersDisplay() {
                const container = document.getElementById('playersListContainer');
                
                if (!this.multiplayer) {
                    container.innerHTML = '<div class="text-gray-400 text-sm">No players connected</div>';
                    return;
                }

                const players = this.multiplayer.getActivePlayers();
                
                if (players.length === 0) {
                    container.innerHTML = '<div class="text-gray-400 text-sm">No players connected</div>';
                    return;
                }

                container.innerHTML = players.map(player => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-white">${player.user}</span>
                        <span class="text-xs text-gray-400">${player.id === this.multiplayer.clientId ? '(You)' : 'Online'}</span>
                    </div>
                `).join('');
            }

            log(message, type = 'info') {
                const logsContainer = document.getElementById('eventLogs');
                const timestamp = new Date().toLocaleTimeString();
                
                const colors = {
                    info: 'text-blue-400',
                    success: 'text-green-400',
                    warn: 'text-yellow-400',
                    error: 'text-red-400',
                    player: 'text-purple-400',
                    score: 'text-cyan-400'
                };

                const logEntry = document.createElement('div');
                logEntry.className = colors[type] || 'text-gray-400';
                logEntry.textContent = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
                
                logsContainer.appendChild(logEntry);
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }

            clearLogs() {
                document.getElementById('eventLogs').innerHTML = '';
                this.log('Logs cleared', 'info');
            }
        }

        // Initialize the test tool when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MultiplayerTestTool();
        });
    </script>
</body>
</html>