<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Flip Game - Mini Arcade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }
        @keyframes match {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .card {
            perspective: 1000px;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: scale(1.05);
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .card-matched {
            animation: match 0.5s ease;
        }
        .card-wrong {
            animation: shake 0.5s ease;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-pink-900 via-violet-900 to-purple-900">
    <div class="container mx-auto px-4 py-8 min-h-screen flex flex-col">
        <!-- Header -->
        <header class="text-center mb-6">
            <div class="flex items-center justify-between mb-4">
                <a href="index.html" class="bg-white/10 backdrop-blur-sm border border-white/20 text-white px-6 py-3 rounded-xl hover:bg-white/20 transition-all duration-300 flex items-center space-x-2">
                    <span>‚Üê</span>
                    <span>Home</span>
                </a>
                <div class="flex items-center space-x-4">
                    <!-- Mode Indicator -->
                    <div id="modeIndicator" class="text-center">
                        <div class="text-sm text-gray-300">Mode</div>
                        <div class="text-lg font-bold text-purple-400" id="gameMode">Singleplayer</div>
                    </div>
                    <!-- Best Time -->
                    <div class="text-right">
                        <div class="text-sm text-gray-300">Best Time</div>
                        <div class="text-2xl font-bold text-pink-400" id="bestTime">---</div>
                    </div>
                </div>
            </div>

            <!-- Multiplayer Player List -->
            <div id="multiplayerInfo" class="hidden mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto">
                    <!-- Online Players -->
                    <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-4">
                        <div class="text-sm text-gray-300 mb-2 flex items-center justify-center space-x-2">
                            <span>üåê Online Players</span>
                            <div id="connectionStatus" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        </div>
                        <div id="playerList" class="space-y-1 max-h-32 overflow-y-auto">
                            <div class="text-gray-400 text-sm">Loading players...</div>
                        </div>
                    </div>
                    
                    <!-- Live Progress & Scores -->
                    <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-4">
                        <div class="text-sm text-gray-300 mb-2 flex items-center justify-center space-x-2">
                            <span>üß† Live Progress</span>
                        </div>
                        <div id="liveScores" class="space-y-1 max-h-32 overflow-y-auto">
                            <div class="text-gray-400 text-sm">No activity yet</div>
                        </div>
                    </div>
                </div>
            </div>
            <h1 class="text-4xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-violet-400 mb-4">
                üß† Memory Flip
            </h1>
            <p class="text-lg text-gray-300" id="gameDescription">Match all pairs in the 4x4 grid!</p>
        </header>

        <!-- Game Stats -->
        <div class="grid grid-cols-3 gap-4 mb-6 text-center max-w-md mx-auto">
            <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-3">
                <div class="text-2xl font-bold text-white" id="timer">0:00</div>
                <div class="text-xs text-gray-300">Time</div>
            </div>
            <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-3">
                <div class="text-2xl font-bold text-pink-400" id="moves">0</div>
                <div class="text-xs text-gray-300">Moves</div>
            </div>
            <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-3">
                <div class="text-2xl font-bold text-violet-400" id="matches">0/8</div>
                <div class="text-xs text-gray-300">Pairs</div>
            </div>
        </div>

        <!-- Game Area -->
        <div class="flex-1 flex items-center justify-center">
            <div class="relative">
                <!-- Start Screen -->
                <div id="startScreen" class="absolute inset-0 bg-black/50 backdrop-blur-sm rounded-2xl flex items-center justify-center z-20">
                    <div class="text-center">
                        <div class="text-6xl mb-4">üß†</div>
                        <button id="startBtn" class="bg-gradient-to-r from-pink-500 to-violet-500 text-white font-bold py-4 px-8 rounded-xl text-xl hover:shadow-lg hover:shadow-pink-500/30 transition-all duration-300 transform hover:scale-105">
                            Start Game
                        </button>
                        <div class="mt-4 text-gray-300 text-sm">Flip cards to find matching pairs!</div>
                    </div>
                </div>

                <!-- Game Over Screen -->
                <div id="gameOverScreen" class="absolute inset-0 bg-black/50 backdrop-blur-sm rounded-2xl flex items-center justify-center z-20 hidden">
                    <div class="text-center bg-black/50 backdrop-blur-sm border border-white/20 rounded-2xl p-8 max-w-lg mx-auto">
                        <div class="text-4xl mb-4">üèÜ</div>
                        <div class="text-3xl font-bold text-white mb-2">Congratulations!</div>
                        <div class="text-xl font-bold text-pink-400 mb-2" id="finalTime">Time: 0:00</div>
                        <div class="text-lg text-gray-300 mb-4" id="finalMoves">0 moves</div>
                        <div class="text-lg text-gray-300 mb-6" id="resultMessage">Perfect memory!</div>
                        
                        <!-- New Record Animation -->
                        <div id="newRecordAlert" class="hidden mb-4 p-3 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl animate-pulse">
                            <div class="text-xl font-bold text-white">üèÜ NEW RECORD! üèÜ</div>
                        </div>

                        <!-- Leaderboard -->
                        <div class="mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Best Score Card -->
                                <div class="bg-gradient-to-br from-pink-500/20 to-violet-500/20 backdrop-blur-sm border border-pink-300/30 rounded-xl p-4">
                                    <div class="text-sm text-pink-300 mb-1">üèÜ Best Time</div>
                                    <div class="text-xl font-bold text-pink-400" id="leaderboardBest">---</div>
                                </div>
                                
                                <!-- Recent Scores -->
                                <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-xl p-4">
                                    <div class="text-sm text-gray-300 mb-2">üìà Recent Times</div>
                                    <div id="recentScoresList" class="space-y-1 text-sm max-h-20 overflow-y-auto">
                                        <div class="text-gray-400">No times yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="playAgainBtn" class="bg-gradient-to-r from-violet-500 to-pink-500 text-white font-bold py-3 px-6 rounded-xl hover:shadow-lg hover:shadow-violet-500/30 transition-all duration-300 transform hover:scale-105">
                            Play Again
                        </button>
                    </div>
                </div>

                <!-- Game Grid -->
                <div id="gameGrid" class="grid grid-cols-4 gap-3 p-6 bg-black/20 backdrop-blur-sm border border-white/20 rounded-2xl">
                    <!-- Cards will be generated here -->
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="text-center mt-6">
            <div class="bg-black/20 backdrop-blur-sm border border-white/10 rounded-xl p-4 max-w-2xl mx-auto">
                <h3 class="text-lg font-bold text-white mb-2">How to Play:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-300">
                    <div>
                        <div class="font-semibold text-pink-400">üéÆ Gameplay:</div>
                        <div>‚Ä¢ Click cards to flip them</div>
                        <div>‚Ä¢ Find matching emoji pairs</div>
                        <div>‚Ä¢ Match all 8 pairs to win</div>
                    </div>
                    <div>
                        <div class="font-semibold text-violet-400">üèÜ Scoring:</div>
                        <div>‚Ä¢ Faster time = better score</div>
                        <div>‚Ä¢ Fewer moves = bonus points</div>
                        <div>‚Ä¢ Perfect memory challenge!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script src="supabase.js"></script>
    <script src="scores.js"></script>
    <script src="pinger.js"></script>
    <script src="multiplayer-core.js"></script>
    <script>
        class MemoryGame {
            constructor() {
                this.gameGrid = document.getElementById('gameGrid');
                this.startScreen = document.getElementById('startScreen');
                this.gameOverScreen = document.getElementById('gameOverScreen');
                this.startBtn = document.getElementById('startBtn');
                this.playAgainBtn = document.getElementById('playAgainBtn');
                
                this.timerEl = document.getElementById('timer');
                this.movesEl = document.getElementById('moves');
                this.matchesEl = document.getElementById('matches');
                this.bestTimeEl = document.getElementById('bestTime');
                
                this.finalTime = document.getElementById('finalTime');
                this.finalMoves = document.getElementById('finalMoves');
                this.resultMessage = document.getElementById('resultMessage');
                this.newRecordAlert = document.getElementById('newRecordAlert');
                this.leaderboardBest = document.getElementById('leaderboardBest');
                this.recentScoresList = document.getElementById('recentScoresList');
                
                this.gameState = 'ready'; // ready, playing, finished
                this.cards = [];
                this.flippedCards = [];
                this.matchedPairs = 0;
                this.moves = 0;
                this.startTime = 0;
                this.gameTimer = null;
                this.canFlip = true;
                this.isMultiplayer = false;
                this.multiplayer = null;
                this.lastProgressBroadcast = 0;
                
                // Emoji pairs for the cards
                this.emojis = ['üéØ', 'üöÄ', '‚≠ê', 'üé®', 'üéµ', 'üèÜ', 'üíé', 'üî•'];
                
                this.initMode();
                this.loadLeaderboard();
                this.bindEvents();
                this.setupGrid();
            }

            initMode() {
                // Check if in multiplayer mode
                const urlParams = new URLSearchParams(window.location.search);
                this.isMultiplayer = urlParams.get('mode') === 'multiplayer';
                
                const gameModeEl = document.getElementById('gameMode');
                const multiplayerInfo = document.getElementById('multiplayerInfo');
                const gameDescription = document.getElementById('gameDescription');
                
                if (this.isMultiplayer) {
                    // Check authentication for multiplayer
                    if (!isAuthenticated()) {
                        console.log('üîê Not authenticated, redirecting to auth page');
                        window.location.href = 'auth.html?return=' + encodeURIComponent(window.location.href);
                        return;
                    }
                    
                    gameModeEl.textContent = 'Multiplayer';
                    gameModeEl.className = 'text-lg font-bold text-green-400';
                    multiplayerInfo.classList.remove('hidden');
                    gameDescription.textContent = 'Race against others! Match all pairs as fast as you can!';
                    
                    console.log('üåê Initializing multiplayer mode for Memory Flip');
                    
                    // Initialize multiplayer
                    this.initMultiplayer();
                } else {
                    gameModeEl.textContent = 'Singleplayer';
                    gameModeEl.className = 'text-lg font-bold text-purple-400';
                    gameDescription.textContent = 'Match all pairs in the 4x4 grid!';
                    
                    console.log('üéØ Running in singleplayer mode');
                }
            }

            async initMultiplayer() {
                try {
                    this.multiplayer = new MultiplayerCore('memory');
                    
                    // Set up event handlers
                    this.multiplayer.on('score_update', (data) => {
                        this.handleMultiplayerScore(data);
                    });

                    this.multiplayer.on('progress_update', (data) => {
                        this.handleMultiplayerProgress(data);
                    });

                    this.multiplayer.on('player_join', (data) => {
                        // Handled by core engine
                    });

                    this.multiplayer.on('player_leave', (data) => {
                        // Handled by core engine
                    });
                    
                    // Connect to multiplayer
                    const connected = await this.multiplayer.connect();
                    
                    if (connected) {
                        console.log('üåê Multiplayer connected for Memory Flip');
                        
                        // Set up periodic connection check
                        setInterval(() => {
                            this.updateConnectionStatus(this.multiplayer.isMultiplayerConnected());
                        }, 5000);
                    }
                    
                } catch (error) {
                    console.error('Failed to initialize multiplayer:', error);
                    this.updateConnectionStatus(false);
                }
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                if (statusEl) {
                    if (connected) {
                        statusEl.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                    } else {
                        statusEl.className = 'w-2 h-2 bg-red-500 rounded-full';
                    }
                }
            }

            handleMultiplayerScore(data) {
                console.log(`üèÜ Final time from ${data.user}: ${this.formatTime(data.score)}`);
                // Score notifications are handled by the core engine
                
                // Show winner popup if someone finished
                this.showWinnerPopup(data);
            }

            handleMultiplayerProgress(data) {
                console.log(`üß† Progress from ${data.user}:`, data.progress);
                // Progress notifications are handled by the core engine
            }

            showWinnerPopup(data) {
                // Create winner notification
                const popup = document.createElement('div');
                popup.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[60]';
                popup.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white p-8 rounded-2xl shadow-2xl text-center animate-pulse max-w-md mx-4">
                        <div class="text-6xl mb-4">üèÜ</div>
                        <div class="text-2xl font-bold mb-2">${data.user} Wins!</div>
                        <div class="text-lg mb-2">Time: ${this.formatTime(data.score)}</div>
                        <div class="text-sm opacity-75">${data.moves || 'Unknown'} moves</div>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                class="mt-4 bg-white/20 text-white px-6 py-2 rounded-lg hover:bg-white/30 transition-colors">
                            Close
                        </button>
                    </div>
                `;
                
                document.body.appendChild(popup);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (popup.parentElement) {
                        popup.remove();
                    }
                }, 10000);
            }

            formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startGame());
                this.playAgainBtn.addEventListener('click', () => this.resetGame());
            }

            setupGrid() {
                this.gameGrid.innerHTML = '';
                this.cards = [];
                
                // Create pairs of emojis
                const cardEmojis = [...this.emojis, ...this.emojis];
                this.shuffle(cardEmojis);
                
                // Create cards
                for (let i = 0; i < 16; i++) {
                    const card = this.createCard(i, cardEmojis[i]);
                    this.gameGrid.appendChild(card);
                    this.cards.push(card);
                }
            }

            createCard(index, emoji) {
                const card = document.createElement('div');
                card.className = 'card w-16 h-16 md:w-20 md:h-20 cursor-pointer';
                card.dataset.index = index;
                card.dataset.emoji = emoji;
                
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front bg-gradient-to-br from-purple-500 to-pink-500 border-2 border-white/30 shadow-lg">
                            <span class="text-2xl">‚ùì</span>
                        </div>
                        <div class="card-back bg-gradient-to-br from-white to-gray-100 border-2 border-purple-300 shadow-lg text-purple-800">
                            <span class="text-2xl">${emoji}</span>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => this.flipCard(card));
                
                return card;
            }

            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            startGame() {
                this.gameState = 'playing';
                this.moves = 0;
                this.matchedPairs = 0;
                this.flippedCards = [];
                this.canFlip = true;
                this.startTime = Date.now();
                
                this.startScreen.classList.add('hidden');
                this.startTimer();
                this.updateDisplay();
                
                // Brief preview of all cards
                this.showPreview();
            }

            showPreview() {
                this.canFlip = false;
                
                // Flip all cards to show them
                this.cards.forEach(card => {
                    card.classList.add('flipped');
                });
                
                // Hide them after 2 seconds
                setTimeout(() => {
                    this.cards.forEach(card => {
                        card.classList.remove('flipped');
                    });
                    this.canFlip = true;
                }, 2000);
            }

            startTimer() {
                this.gameTimer = setInterval(() => {
                    if (this.gameState === 'playing') {
                        this.updateTimer();
                    }
                }, 1000);
            }

            updateTimer() {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                this.timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            flipCard(card) {
                if (!this.canFlip || this.gameState !== 'playing') return;
                if (card.classList.contains('flipped')) return;
                if (this.flippedCards.includes(card)) return;
                
                card.classList.add('flipped');
                this.flippedCards.push(card);
                
                if (this.flippedCards.length === 2) {
                    this.moves++;
                    this.updateDisplay();
                    this.checkMatch();
                }
            }

            checkMatch() {
                this.canFlip = false;
                const [card1, card2] = this.flippedCards;
                const emoji1 = card1.dataset.emoji;
                const emoji2 = card2.dataset.emoji;
                
                setTimeout(() => {
                    if (emoji1 === emoji2) {
                        // Match found!
                        this.handleMatch(card1, card2);
                    } else {
                        // No match
                        this.handleMismatch(card1, card2);
                    }
                    
                    this.flippedCards = [];
                    this.canFlip = true;
                }, 1000);
            }

            handleMatch(card1, card2) {
                card1.classList.add('card-matched');
                card2.classList.add('card-matched');
                
                // Keep cards flipped and add matched styling
                setTimeout(() => {
                    card1.style.opacity = '0.7';
                    card2.style.opacity = '0.7';
                    card1.style.pointerEvents = 'none';
                    card2.style.pointerEvents = 'none';
                }, 500);
                
                this.matchedPairs++;
                this.updateDisplay();
                
                if (this.matchedPairs === 8) {
                    this.endGame();
                }
            }

            handleMismatch(card1, card2) {
                card1.classList.add('card-wrong');
                card2.classList.add('card-wrong');
                
                setTimeout(() => {
                    card1.classList.remove('flipped', 'card-wrong');
                    card2.classList.remove('flipped', 'card-wrong');
                }, 500);
            }

            updateDisplay() {
                this.movesEl.textContent = this.moves;
                this.matchesEl.textContent = `${this.matchedPairs}/8`;
                
                // Broadcast progress in multiplayer mode (throttled to significant events)
                if (this.isMultiplayer && this.multiplayer && this.gameState === 'playing') {
                    const now = Date.now();
                    // Broadcast on every match or every 3 moves (whichever comes first)
                    if (this.moves % 3 === 0 || now - this.lastProgressBroadcast > 3000) {
                        this.lastProgressBroadcast = now;
                        const elapsed = Math.floor((now - this.startTime) / 1000);
                        this.multiplayer.broadcastProgress({
                            matches: this.matchedPairs,
                            moves: this.moves,
                            timeElapsed: elapsed,
                            completion: (this.matchedPairs / 8) * 100
                        });
                    }
                }
            }

            endGame() {
                this.gameState = 'finished';
                clearInterval(this.gameTimer);
                
                const totalTime = Math.floor((Date.now() - this.startTime) / 1000);
                this.showResults(totalTime);
                this.saveScore(totalTime);
            }

            showResults(totalTime) {
                const minutes = Math.floor(totalTime / 60);
                const seconds = totalTime % 60;
                const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                this.finalTime.textContent = `Time: ${timeString}`;
                this.finalMoves.textContent = `${this.moves} moves`;
                
                let message = '';
                if (this.moves <= 20) {
                    message = 'üß† INCREDIBLE! Perfect memory!';
                } else if (this.moves <= 30) {
                    message = '‚≠ê EXCELLENT! Great concentration!';
                } else if (this.moves <= 40) {
                    message = 'üëç GOOD JOB! Nice work!';
                } else if (this.moves <= 50) {
                    message = 'üòä NOT BAD! Keep practicing!';
                } else {
                    message = 'ü§î KEEP TRYING! Memory improves with practice!';
                }
                
                this.resultMessage.textContent = message;
                this.gameOverScreen.classList.remove('hidden');
            }

            resetGame() {
                this.gameState = 'ready';
                clearInterval(this.gameTimer);
                
                this.gameOverScreen.classList.add('hidden');
                this.startScreen.classList.remove('hidden');
                
                this.moves = 0;
                this.matchedPairs = 0;
                this.flippedCards = [];
                this.canFlip = true;
                
                this.timerEl.textContent = '0:00';
                this.updateDisplay();
                this.setupGrid();
            }

            loadLeaderboard() {
                const best = localStorage.getItem('memoryBest');
                const recentScores = JSON.parse(localStorage.getItem('memoryRecent') || '[]');
                
                if (best) {
                    const seconds = parseInt(best);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    const timeString = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                    this.bestTimeEl.textContent = timeString;
                    this.leaderboardBest.textContent = timeString;
                } else {
                    this.bestTimeEl.textContent = '---';
                    this.leaderboardBest.textContent = '---';
                }
                
                this.updateRecentScoresList(recentScores);
            }

            updateRecentScoresList(scores) {
                if (scores.length === 0) {
                    this.recentScoresList.innerHTML = '<div class="text-gray-400">No times yet</div>';
                    return;
                }
                
                this.recentScoresList.innerHTML = scores.map((time, index) => {
                    const minutes = Math.floor(time / 60);
                    const seconds = time % 60;
                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    return `<div class="flex justify-between items-center text-gray-300">
                        <span>#${index + 1}</span>
                        <span class="font-mono">${timeString}</span>
                    </div>`;
                }).join('');
            }

            async saveScore(totalTime) {
                const currentUser = getCurrentUser();
                const username = currentUser ? currentUser.username : 'Anonymous';
                
                // Get current scores
                const currentBest = localStorage.getItem('memoryBest');
                const recentScores = JSON.parse(localStorage.getItem('memoryRecent') || '[]');
                
                // Check for new best (lower time is better)
                const isNewRecord = !currentBest || totalTime < parseInt(currentBest);
                
                if (isNewRecord) {
                    localStorage.setItem('memoryBest', totalTime.toString());
                    const minutes = Math.floor(totalTime / 60);
                    const seconds = totalTime % 60;
                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    this.bestTimeEl.textContent = timeString;
                    this.leaderboardBest.textContent = timeString;
                    
                    // Show new record animation
                    this.showNewRecord();
                    
                    // Update header best score with animation
                    this.bestTimeEl.className = 'text-2xl font-bold text-green-400 animate-pulse';
                    setTimeout(() => {
                        this.bestTimeEl.className = 'text-2xl font-bold text-pink-400';
                    }, 2000);
                }
                
                // Add to recent scores (keep only last 5)
                recentScores.unshift(totalTime);
                if (recentScores.length > 5) {
                    recentScores.pop();
                }
                localStorage.setItem('memoryRecent', JSON.stringify(recentScores));
                
                // Save to database if available
                try {
                    if (window.saveScore) {
                        const saveResult = await saveScore('memory', username, totalTime, {
                            isNewRecord: isNewRecord,
                            moves: this.moves,
                            matchedPairs: this.matchedPairs,
                            timestamp: new Date().toISOString()
                        });
                        
                        if (saveResult.database) {
                            console.log('MINI-ARCADE: Memory game score saved to database successfully');
                        } else if (saveResult.local) {
                            console.log('MINI-ARCADE: Memory game score saved locally only');
                        }
                    }
                } catch (error) {
                    console.error('MINI-ARCADE: Failed to save memory game score to database:', error);
                }
                
                // Update recent scores display
                this.updateRecentScoresList(recentScores);
                
                // Broadcast final score in multiplayer mode
                if (this.isMultiplayer && this.multiplayer) {
                    console.log(`MINI-ARCADE: Broadcasting memory game completion: ${totalTime}s`);
                    this.multiplayer.broadcastScore(totalTime, {
                        isNewRecord: isNewRecord,
                        moves: this.moves,
                        matchedPairs: this.matchedPairs,
                        gameCompleted: true
                    });
                }
                
                return isNewRecord;
            }

            showNewRecord() {
                this.newRecordAlert.classList.remove('hidden');
                setTimeout(() => {
                    this.newRecordAlert.classList.add('hidden');
                }, 3000);
            }
        }

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MemoryGame();
        });
    </script>
</body>
</html>